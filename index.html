<script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>
<script>
  const ONESIGNAL_APP_ID   = "2c2cf4aa-07ec-4b11-8234-76d452ea3ad5";
  const SCRIPT_WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbyEEXf2u18UEbfYSamjwYC58mohEPinibLsXt6Bu9fCkaA8cr2h6oubL2A_KxJUji6C/exec";

  // Use PATH ONLY here because dashboard already has the filenames
  window.OneSignal = window.OneSignal || [];
  OneSignal.push(function () {
    OneSignal.init({
      appId: ONESIGNAL_APP_ID,
      serviceWorkerPath: '/falowen/',   // <- IMPORTANT: path, not file
      notifyButton: { enable: false }
    });
  });

  async function ensureOneSignalReady(timeoutMs = 10000) {
    const t0 = Date.now();
    return new Promise((resolve, reject) => {
      (function tick(){
        if (window.OneSignal && OneSignal.User && OneSignal.Notification) return resolve(window.OneSignal);
        if (Date.now() - t0 > timeoutMs) return reject(new Error("OneSignal SDK didn't initialize. Check Site URL & worker paths."));
        setTimeout(tick, 150);
      })();
    });
  }

  document.getElementById('btn').onclick = async () => {
    const s = document.getElementById('status');
    const code = (document.getElementById('code').value || '').trim();
    if (!code) { s.innerHTML = '<span class="err">Enter your student code.</span>'; return; }
    try {
      const OneSignal = await ensureOneSignalReady();
      await OneSignal.Notification.requestPermission();
      const playerId = await OneSignal.User.getId();
      if (!playerId) throw new Error('Permission denied or playerId unavailable.');

      const r = await fetch(SCRIPT_WEBHOOK_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ type:'onesignal_register', studentcode: code, playerId })
      });
      const j = await r.json();
      if (!j.ok) throw new Error(j.error || 'Server error');
      s.innerHTML = '<span class="ok">âœ… Notifications enabled. You will receive updates.</span>';
    } catch (e) {
      console.error(e);
      s.innerHTML = '<span class="err">Failed: ' + e.message + '</span>';
    }
  };
</script>
